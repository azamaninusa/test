name: Docker Tests - Simple

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DOCKER_IMAGE: vaxcare-tests

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t ${{ env.DOCKER_IMAGE }}:latest .

      - name: Create test results directory
        run: |
          mkdir -p TestResults/screenshots TestResults/html
          chmod -R 777 TestResults || true
          echo "Created TestResults directory structure"
          ls -la TestResults/ || true

      - name: Run tests
        id: run_tests
        run: |
          echo "Running tests in Docker..."
          echo "Volume mount: ${{ github.workspace }}/TestResults -> /app/TestResults"
          echo "Checking host directory before Docker run:"
          ls -la TestResults/ || echo "TestResults not found on host"
          echo ""
          echo "=== Running tests (output will show screenshot capture attempts) ==="
          # Run tests and capture exit code
          set +e  # Don't exit on error immediately
          docker run --rm \
            --name vaxcare-tests \
            -v "${{ github.workspace }}/TestResults:/app/TestResults:rw" \
            ${{ env.DOCKER_IMAGE }}:latest \
            --filter "FullyQualifiedName~GoogleSearchTest" 2>&1 | tee test-output.log
          TEST_EXIT_CODE=${PIPESTATUS[0]}  # Get exit code from docker run (not tee)
          set -e  # Re-enable exit on error
          
          echo "Docker run exit code: $TEST_EXIT_CODE"
          echo "TEST_EXIT_CODE=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
          echo ""
          echo "=== Checking for screenshot-related messages in test output ==="
          grep -i "screenshot" test-output.log || echo "No screenshot messages found in output"
          echo ""
          echo "=== Checking for screenshot errors ==="
          grep -i "failed to capture\|screenshot.*fail\|driver.*null" test-output.log || echo "No screenshot errors found"
          echo ""
          echo "=== Checking test failure messages ==="
          grep -i "test failed\|exception\|error" test-output.log | head -20 || echo "No failure messages found"
          echo ""
          echo "Docker container finished"
          echo "Checking host directory after Docker run:"
          ls -la TestResults/ || echo "TestResults not found on host"
          ls -la TestResults/screenshots/ || echo "Screenshots directory not found"

      - name: Verify Docker container paths
        if: always()
        run: |
          echo "=== Verifying paths inside container ==="
          # Check if /app/TestResults exists and is writable
          docker run --rm \
            -v "${{ github.workspace }}/TestResults:/app/TestResults:rw" \
            ${{ env.DOCKER_IMAGE }}:latest \
            sh -c "
              echo 'Checking /app/TestResults directory:'
              ls -la /app/TestResults/ || echo 'Directory not found'
              echo ''
              echo 'Checking /app/TestResults/screenshots:'
              ls -la /app/TestResults/screenshots/ 2>&1 || echo 'Screenshots directory not found'
              echo ''
              echo 'Testing write permissions:'
              touch /app/TestResults/screenshots/test-write.txt 2>&1 && echo 'Write test: SUCCESS' || echo 'Write test: FAILED'
              rm -f /app/TestResults/screenshots/test-write.txt 2>&1
              echo ''
              echo 'Checking if Directory.Exists would find /app/TestResults:'
              echo 'Path exists check would return: true (if directory exists)'
            " || true

      - name: Check screenshots after test
        if: always()
        run: |
          echo "=== Checking TestResults directory on host ==="
          ls -la TestResults/ || echo "TestResults directory not found"
          echo ""
          echo "=== Checking screenshots directory ==="
          if [ -d "TestResults/screenshots" ]; then
            echo "Screenshots directory exists"
            echo "Directory permissions:"
            ls -ld TestResults/screenshots/
            echo "Directory contents:"
            ls -la TestResults/screenshots/ || echo "Cannot list screenshots directory"
            echo ""
            echo "=== Searching for PNG files ==="
            find TestResults/screenshots -type f -name "*.png" 2>/dev/null || echo "No PNG files found"
            SCREENSHOT_COUNT=$(find TestResults/screenshots -type f -name "*.png" 2>/dev/null | wc -l || echo "0")
            echo "Screenshot count: $SCREENSHOT_COUNT"
            if [ "$SCREENSHOT_COUNT" -eq 0 ]; then
              echo "WARNING: No screenshots found!"
              echo "This could mean:"
              echo "1. Test passed (screenshots only captured on failure)"
              echo "2. Screenshot capture failed silently"
              echo "3. Volume mount issue"
            fi
          else
            echo "Screenshots directory does not exist"
            echo "Creating it now..."
            mkdir -p TestResults/screenshots
            ls -la TestResults/ || true
          fi

      - name: Check screenshots
        if: always()
        id: check_screenshots
        run: |
          mkdir -p TestResults/screenshots
          SCREENSHOT_COUNT=$(find TestResults/screenshots -type f -name "*.png" 2>/dev/null | wc -l || echo "0")
          echo "Found $SCREENSHOT_COUNT screenshot(s)"
          if [ "$SCREENSHOT_COUNT" -gt 0 ]; then
            echo "has_screenshots=true" >> $GITHUB_OUTPUT
            echo "Screenshots found:"
            find TestResults/screenshots -type f -name "*.png" | head -10
          else
            echo "has_screenshots=false" >> $GITHUB_OUTPUT
            echo "No screenshots found. Checking directory contents:"
            ls -la TestResults/screenshots/ || echo "Directory is empty or inaccessible"
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResults
          retention-days: 7
          if-no-files-found: ignore
          compression-level: 6

      - name: Upload screenshots
        if: always() && steps.check_screenshots.outputs.has_screenshots == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: TestResults/screenshots
          retention-days: 7
          if-no-files-found: warn
          compression-level: 6

      - name: Check test results
        if: always()
        id: check_test_results
        run: |
          TEST_EXIT_CODE="${{ steps.run_tests.outputs.TEST_EXIT_CODE }}"
          echo "Test exit code: $TEST_EXIT_CODE"
          
          # Check if TRX file exists and parse it for failures
          if [ -f "TestResults/TestResults.trx" ]; then
            echo "TRX file found, checking for test failures..."
            # Count failed tests in TRX file
            FAILED_COUNT=$(grep -o 'outcome="Failed"' TestResults/TestResults.trx | wc -l || echo "0")
            echo "Failed test count from TRX: $FAILED_COUNT"
            
            if [ "$FAILED_COUNT" -gt 0 ]; then
              echo "TESTS_FAILED=true" >> $GITHUB_OUTPUT
              echo "‚ùå Tests failed: $FAILED_COUNT test(s) failed"
            else
              echo "TESTS_FAILED=false" >> $GITHUB_OUTPUT
              echo "‚úÖ All tests passed"
            fi
          else
            echo "TRX file not found"
            # If docker run failed and no TRX file, tests definitely failed
            if [ "$TEST_EXIT_CODE" != "0" ]; then
              echo "TESTS_FAILED=true" >> $GITHUB_OUTPUT
              echo "‚ùå Tests failed: Docker run exited with code $TEST_EXIT_CODE"
            else
              echo "TESTS_FAILED=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Generate test summary
        if: always()
        run: |
          echo "# üìä Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "TestResults/TestResults.trx" ]; then
            # Parse TRX file to extract test results
            TOTAL_TESTS=$(grep '<UnitTestResult' TestResults/TestResults.trx | grep -oE 'outcome="[^"]*"' | wc -l || echo "0")
            PASSED_COUNT=$(grep '<UnitTestResult' TestResults/TestResults.trx | grep -oE 'outcome="Passed"' | wc -l || echo "0")
            FAILED_COUNT=$(grep '<UnitTestResult' TestResults/TestResults.trx | grep -oE 'outcome="Failed"' | wc -l || echo "0")
            SKIPPED_COUNT=$(grep '<UnitTestResult' TestResults/TestResults.trx | grep -oE 'outcome="(NotExecuted|Skipped)"' | wc -l || echo "0")
            
            echo "## Test Statistics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ‚úÖ Passed | $PASSED_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚ùå Failed | $FAILED_COUNT |" >> $GITHUB_STEP_SUMMARY
            if [ "$SKIPPED_COUNT" -gt 0 ]; then
              echo "| ‚è≠Ô∏è Skipped | $SKIPPED_COUNT |" >> $GITHUB_STEP_SUMMARY
            fi
            echo "| üìä Total | $TOTAL_TESTS |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Calculate success rate
            if [ "$TOTAL_TESTS" -gt 0 ]; then
              SUCCESS_RATE=$(awk "BEGIN {printf \"%.1f\", ($PASSED_COUNT / $TOTAL_TESTS) * 100}")
              echo "**Success Rate: ${SUCCESS_RATE}%**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## ‚ö†Ô∏è Test Results Not Available" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "TRX file not found. Cannot generate test summary." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            TEST_EXIT_CODE="${{ steps.run_tests.outputs.TEST_EXIT_CODE }}"
            if [ "$TEST_EXIT_CODE" != "0" ]; then
              echo "Docker run exited with code: \`$TEST_EXIT_CODE\`" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Fail workflow if tests failed
        if: steps.check_test_results.outputs.TESTS_FAILED == 'true'
        run: |
          echo "‚ùå Test failures detected. Failing workflow."
          exit 1

