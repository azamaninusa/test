name: Docker Tests - Google Search Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DOCKER_IMAGE: vaxcare-tests
  DOCKERFILE: Dockerfile

jobs:
  # Build Docker image once and push to cache
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /opt/microsoft
          echo "Disk space after cleanup:"
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE }}
          tags: ${{ env.DOCKER_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true
          push: false

      - name: Check disk space after build
        run: |
          echo "Disk space after Docker build:"
          df -h
          echo "Docker disk usage:"
          docker system df

      - name: Save Docker image
        run: |
          docker save ${{ env.DOCKER_IMAGE }}:latest | gzip > docker-image.tar.gz
          echo "Compressed image size:"
          ls -lh docker-image.tar.gz

      - name: Clean up Docker resources
        if: always()
        run: |
          docker system prune -af --volumes || true
          echo "Disk space after cleanup:"
          df -h

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: docker-image.tar.gz
          retention-days: 1
          compression-level: 9

  # Run Google Search Test
  test:
    name: Run Google Search Test
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /opt/microsoft
          echo "Disk space after cleanup:"
          df -h

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: .

      - name: Load Docker image
        run: |
          echo "Disk space before loading image:"
          df -h
          docker load < docker-image.tar.gz
          echo "Disk space after loading image:"
          df -h
          echo "Docker disk usage:"
          docker system df

      - name: Create test results directory
        run: |
          mkdir -p TestResults
          mkdir -p TestResults/screenshots
          mkdir -p TestResults/html

      - name: Run Google Search Test in Docker
        id: run_tests
        continue-on-error: true
        run: |
          docker run --rm \
            --name vaxcare-tests-google-search \
            -v "${{ github.workspace }}/TestResults:/app/TestResults" \
            ${{ env.DOCKER_IMAGE }}:latest \
            --filter "FullyQualifiedName~GoogleSearchTest"

      - name: Clean up Docker resources
        if: always()
        run: |
          # Remove stopped containers
          docker container prune -f || true
          # Remove unused images
          docker image prune -af || true
          # Remove unused volumes
          docker volume prune -f || true
          # Remove build cache
          docker builder prune -af || true
          echo "Disk space after cleanup:"
          df -h
          echo "Docker disk usage:"
          docker system df

      - name: Check test results
        if: steps.run_tests.outcome == 'failure'
        run: |
          echo "Google Search Test failed"
          exit 1

      - name: Upload TRX report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trx-report-google-search
          path: TestResults/TestResults.trx
          retention-days: 7
          if-no-files-found: ignore
          compression-level: 6

      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: html-report-google-search
          path: TestResults/html/TestReport.html
          retention-days: 7
          if-no-files-found: ignore
          compression-level: 6

      - name: Check screenshots directory
        if: always()
        id: check_screenshots
        run: |
          echo "Checking for screenshots..."
          # Ensure directory exists
          mkdir -p TestResults/screenshots
          if [ -d "TestResults/screenshots" ]; then
            echo "Screenshots directory exists"
            ls -la TestResults/screenshots/ || echo "Directory is empty or inaccessible"
            SCREENSHOT_COUNT=$(find TestResults/screenshots -type f -name "*.png" 2>/dev/null | wc -l || echo "0")
            echo "Found $SCREENSHOT_COUNT screenshot(s)"
            if [ "$SCREENSHOT_COUNT" -gt 0 ]; then
              echo "Screenshots found:"
              find TestResults/screenshots -type f -name "*.png" | head -10
              echo "has_screenshots=true" >> $GITHUB_OUTPUT
            else
              echo "No PNG files found in screenshots directory"
              echo "has_screenshots=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Screenshots directory does not exist"
            echo "has_screenshots=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload screenshots (if test failed)
        if: always() && steps.check_screenshots.outputs.has_screenshots == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-google-search
          path: TestResults/screenshots
          retention-days: 7
          if-no-files-found: warn
          compression-level: 6

      - name: Upload all test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-google-search
          path: TestResults
          retention-days: 7
          if-no-files-found: ignore
          compression-level: 6

      - name: Final cleanup
        if: always()
        run: |
          # Remove downloaded image file
          rm -f docker-image.tar.gz || true
          # Final Docker cleanup
          docker system prune -af --volumes || true
          echo "Final disk space:"
          df -h

  # Publish test results summary
  publish-results:
    name: Publish Test Results
    needs: test
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download HTML report
        uses: actions/download-artifact@v4
        with:
          name: html-report-google-search
          path: Reports
          if-no-files-found: ignore

      - name: Test Results Summary
        run: |
          echo "## ðŸ§ª Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Executed:" >> $GITHUB_STEP_SUMMARY
          echo "- Google Search Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Reports Available:" >> $GITHUB_STEP_SUMMARY
          echo "Check the Artifacts section for detailed HTML report." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Screenshots:" >> $GITHUB_STEP_SUMMARY
          echo "Screenshots are automatically captured on test failure and uploaded as artifacts." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Execution Details:" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Test ran in Docker container with headless Chrome" >> $GITHUB_STEP_SUMMARY
          echo "âœ… HTML report generated automatically" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Screenshots captured on failure" >> $GITHUB_STEP_SUMMARY

